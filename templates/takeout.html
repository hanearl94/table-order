{% extends "base.html" %}
{% block content %}
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h2>ü•° Takeout Order</h2>
      <a href="/" class="btn ghost">‚Üê Dine In</a>
    </div>
    
    <form id="takeout-form" action="/takeout-order" method="POST">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
        <div class="table-row">
          <label for="customer_name">Customer Name *</label>
          <input id="customer_name" name="customer_name" type="text" placeholder="e.g. John Smith" required>
        </div>
        <div class="table-row">
          <label for="phone_number">Phone Number *</label>
          <input id="phone_number" name="phone_number" type="tel" 
                 placeholder="(555) 123-4567 or +1 555 123 4567" 
                 pattern="[\+]?[0-9\s\-\(\)\.]{10,15}"
                 title="Enter a valid phone number (10-11 digits for US, or international with +)"
                 required>
          <small style="color:#666;font-size:11px;">üì± Accepts: (555) 123-4567, 555-123-4567, +1 555 123 4567</small>
        </div>
      </div>

      <h3>Menu</h3>
      <div class="menu-grid">
        {% for item in menu %}
          <div class="menu-item" data-item-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.price }}">
            <div class="menu-name">{{ item.name }}</div>
            <div class="menu-price">${{ "%.2f"|format(item.price) }}</div>
            <div class="qty-row">
              <label>Qty</label>
              <input type="number" name="qty_{{ item.id }}" min="0" value="0">
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="actions">
        <button type="submit">Place Takeout Order</button>
      </div>

      <div id="summary" class="summary hidden"></div>
    </form>
  </section>

  <section class="card">
    <h3>Track Your Takeout Orders</h3>
    <p class="muted">Track your orders by Order ID or Phone Number</p>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <!-- Track by Order ID -->
      <div>
        <h4>Track by Order ID</h4>
        <form onsubmit="trackByOrderId(event)">
          <div class="table-row">
            <label for="track-order-id">Order ID</label>
            <input id="track-order-id" type="number" min="1" placeholder="e.g. 123" required>
          </div>
          <div class="actions">
            <button type="submit">Track Order</button>
          </div>
        </form>
      </div>
      
      <!-- Track by Phone Number -->
      <div>
        <h4>Track by Phone Number</h4>
        <form onsubmit="trackByPhone(event)">
          <div class="table-row">
            <label for="track-phone">Phone Number</label>
            <input id="track-phone" type="tel" placeholder="e.g. (555) 123-4567" required>
          </div>
          <div class="actions">
            <button type="submit">View All Orders</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script src="/static/script.js"></script>
  <script>
  function trackByOrderId(event) {
    event.preventDefault();
    const orderId = document.getElementById('track-order-id').value;
    if (orderId) {
      window.location.href = `/track/${orderId}`;
    }
  }
  
  function trackByPhone(event) {
    event.preventDefault();
    const phone = document.getElementById('track-phone').value.trim();
    if (phone) {
      // Encode the phone number for URL safety
      const encodedPhone = encodeURIComponent(phone);
      window.location.href = `/phone/${encodedPhone}`;
    }
  }

  // Phone number formatting and validation
  function formatPhoneNumber(input) {
    let value = input.value.replace(/[^\d+]/g, '');
    
    // Don't format international numbers (starting with +)
    if (value.startsWith('+')) {
      input.value = value;
      return;
    }
    
    // Format US numbers as user types
    if (value.length >= 6) {
      value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
    } else if (value.length >= 3) {
      value = value.replace(/(\d{3})(\d{3})/, '($1) $2');
    }
    
    input.value = value;
  }
  
  function validatePhoneNumber(phone) {
    const digitsOnly = phone.replace(/[^\d+]/g, '');
    
    if (digitsOnly.startsWith('+')) {
      // International: +1 to +999 followed by 7-15 digits
      return digitsOnly.length >= 8 && digitsOnly.length <= 16;
    } else {
      // US: 10 or 11 digits
      return digitsOnly.length === 10 || (digitsOnly.length === 11 && digitsOnly.startsWith('1'));
    }
  }

  // Reuse the existing menu interaction script
  document.addEventListener('DOMContentLoaded', () => {
    // Phone number formatting
    const phoneInput = document.getElementById('phone_number');
    phoneInput.addEventListener('input', (e) => {
      formatPhoneNumber(e.target);
    });
    
    // Phone validation on form submit
    const takeoutForm = document.getElementById('takeout-form');
    takeoutForm.addEventListener('submit', (e) => {
      const phone = phoneInput.value.trim();
      if (!validatePhoneNumber(phone)) {
        e.preventDefault();
        alert('Please enter a valid phone number:\n\n‚Ä¢ US: (555) 123-4567 or 555-123-4567\n‚Ä¢ International: +1 555 123 4567');
        phoneInput.focus();
        return false;
      }
    });
    
    // Add event listeners for quantity changes to show live summary
    const form = document.getElementById('takeout-form');
    const summary = document.getElementById('summary');
    
    form.addEventListener('input', (e) => {
      if (e.target.type === 'number' && e.target.name.startsWith('qty_')) {
        updateSummary();
      }
    });
    
    function updateSummary() {
      const items = [];
      let total = 0;
      
      document.querySelectorAll('.menu-item').forEach(item => {
        const id = item.dataset.itemId;
        const name = item.dataset.name;
        const price = parseFloat(item.dataset.price);
        const qtyInput = item.querySelector(`input[name="qty_${id}"]`);
        const qty = parseInt(qtyInput.value) || 0;
        
        if (qty > 0) {
          items.push(`${qty}x ${name} ($${(qty * price).toFixed(2)})`);
          total += qty * price;
        }
      });
      
      if (items.length > 0) {
        summary.innerHTML = `
          <h4>Order Summary</h4>
          <ul>
            ${items.map(item => `<li>${item}</li>`).join('')}
          </ul>
          <div class="total"><strong>Total: $${total.toFixed(2)}</strong></div>
        `;
        summary.classList.remove('hidden');
      } else {
        summary.classList.add('hidden');
      }
    }
  });
  </script>
{% endblock %}

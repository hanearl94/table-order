{% extends "base.html" %}
{% block content %}
<section class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
    <h2>Incoming Orders</h2>
    <div class="btn-row" id="filter-btns">
      <button class="btn active" data-filter="all">All</button>
      <button class="btn" data-filter="active">Active</button>
      <button class="btn" data-filter="done">Done</button>
    </div>
    <div id="last-refresh" class="muted"></div>
  </div>

  <div id="orders-empty" class="muted" style="margin:8px 0;">No orders yet.</div>

  <div class="table-wrapper">
    <table id="orders-table" class="orders-table hidden">
      <thead>
        <tr>
          <th>ID</th>
          <th>Time</th>
          <th>Table</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
function formatMoney(n){ return `$${Number(n).toFixed(2)}`; }
function fmt(t){ return new Date(t.replace(' ', 'T')).toLocaleString(); }

let currentFilter = 'all';

async function loadOrders() {
  const res = await fetch(`/orders.json?filter=${currentFilter}`, { cache: 'no-store' });
  const data = await res.json();
  const orders = data.orders || [];

  const empty = document.getElementById('orders-empty');
  const table = document.getElementById('orders-table');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';

  if (orders.length === 0) {
    empty.classList.remove('hidden');
    table.classList.add('hidden');
  } else {
    empty.classList.add('hidden');
    table.classList.remove('hidden');

    for (const o of orders) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.id}</td>
        <td>${fmt(o.created_at)}</td>
        <td>Table ${o.table_number}</td>
        <td>${o.items}</td>
        <td>${formatMoney(o.total)}</td>
        <td>
          <span class="badge badge--${o.status}">${o.status}</span>
        </td>
        <td>
          <div class="btn-row">
            <button class="btn ghost" data-action="set" data-id="${o.id}" data-status="new">New</button>
            <button class="btn warn" data-action="set" data-id="${o.id}" data-status="prepping">Prepping</button>
            <button class="btn ok" data-action="set" data-id="${o.id}" data-status="done">Done</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  document.getElementById('last-refresh').textContent =
    'Last refresh: ' + new Date().toLocaleTimeString();
}

async function setStatus(id, status) {
  const res = await fetch(`/orders/${id}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert('Failed to update: ' + (err.error || res.status));
    return;
  }
  // After update, refresh list
  loadOrders();
}

document.addEventListener('DOMContentLoaded', () => {
  loadOrders();
  setInterval(loadOrders, 5000);

  document.getElementById('filter-btns').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-filter]');
    if (!btn) return;

    currentFilter = btn.dataset.filter;
    // Visually update active button
    for (const b of btn.parentElement.children) {
      b.classList.toggle('active', b === btn);
    }
    loadOrders(); // Reload immediately
  });

  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="set"]');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const status = btn.getAttribute('data-status');
    setStatus(id, status);
  });
});
</script>
{% endblock %}
